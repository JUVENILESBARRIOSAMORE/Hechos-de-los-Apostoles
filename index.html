<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misi√≥n: HECHOS | App Juvenil</title>
    <style>
        :root {
            --bg-color: #0f0f13;
            --card-bg: #1a1a20;
            --accent: #ffae00; 
            --text-main: #ffffff;
            --success: #00ff9d;
            --error: #ff4f4f;
            --font-main: 'Segoe UI', Roboto, sans-serif;
        }

        body { 
            background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-main); 
            margin: 0; padding-bottom: 90px; user-select: none;
            background-image: url('portada.jpg'); background-size: cover; background-attachment: fixed; background-position: center;
        }
        
        /* HEADER */
        header { 
            background: rgba(26, 26, 32, 0.95); padding: 8px 15px; border-bottom: 2px solid var(--accent); 
            position: sticky; top: 0; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; flex-direction: column; }
        .header-left h1 { margin: 0; font-size: 0.9rem; color: var(--accent); text-transform: uppercase; }
        .header-left .agent-name { font-size: 0.7rem; color: var(--success); font-weight: bold; }
        
        .header-right { display: flex; align-items: center; gap: 10px; }
        .timer-box { font-family: monospace; font-size: 1.1rem; background: #000; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #fff; }
        .score-box { font-size: 0.9rem; font-weight: bold; color: gold; cursor: pointer; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; display: none; animation: slideUp 0.4s ease-out; }
        .card.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        h2 { border-left: 4px solid var(--accent); padding-left: 10px; margin-top: 0; font-size: 1.2rem; }
        .img-box { width: 100%; border-radius: 10px; overflow: hidden; margin: 15px 0; border: 1px solid #444; background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center;}
        .img-box img { width: 100%; display: block; object-fit: cover; }

        .btn { background: transparent; border: 2px solid var(--accent); color: var(--accent); padding: 12px; border-radius: 50px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 700; text-transform: uppercase; display: block; text-align: center; text-decoration: none; box-sizing: border-box; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent); color: #000; }

        input, select { background: #25252e; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; text-align: center; }
        input:focus, select:focus { outline: none; border-color: var(--accent); }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .stats-table td, .stats-table th { padding: 8px; border-bottom: 1px solid #333; text-align: left; }
        .stats-table th { color: #aaa; font-size: 0.8rem; }
        .stats-table .highlight { color: var(--accent); font-weight: bold; }
        .rank-1 { color: gold; } .rank-2 { color: silver; } .rank-3 { color: #cd7f32; }

        /* JUEGOS */
        .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mem-card { 
            aspect-ratio: 1; background: #333; border-radius: 8px; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; text-align: center; 
            font-size: 0.7rem; padding: 5px; cursor: pointer; transform: scale(1); transition: 0.3s;
        }
        .mem-card.flipped { background: var(--accent); color: black; font-weight: bold; border-color: white; transform: rotateY(180deg); }
        .mem-card.matched { background: var(--success); color: black; opacity: 0.5; pointer-events: none; }

        #hangman-word { font-family: monospace; font-size: 2rem; letter-spacing: 5px; text-align: center; margin: 20px 0; color: var(--success); word-break: break-all;}
        .keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .key-btn { background: #333; padding: 10px 0; text-align: center; border-radius: 4px; cursor: pointer; font-weight: bold; border: 1px solid #444; }
        .key-btn.correct { background: var(--success); color: black; }
        .key-btn.wrong { background: var(--error); opacity: 0.3; }

        /* PUZZLE */
        #puzzle-container { position: relative; width: 300px; height: 300px; margin: 0 auto; border: 2px solid var(--accent); background: #000; overflow: hidden; border-radius: 8px; touch-action: none; }
        .puzzle-piece { 
            position: absolute; width: 100px; height: 100px; 
            background-size: 300px 300px; border: 1px solid #000; box-sizing: border-box; 
            transition: all 0.2s ease; cursor: pointer; 
            background-color: #333; color: rgba(255,255,255,0.2); 
            display: flex; justify-content: center; align-items: center; font-size: 2rem;
        }
        .no-transition { transition: none !important; }

        .word-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin-top: 15px; }
        .cell { aspect-ratio: 1; background: #25252e; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 0.8rem; }
        .cell.selected { background: var(--accent); color: black; }
        .cell.found { background: var(--success); color: black; }

        .crossword-container { margin-bottom: 20px; border: 1px solid #333; padding: 10px; border-radius: 8px; }
        .cw-item { margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .cw-clue { font-size: 0.85rem; margin-bottom: 5px; color: #ccc; }
        .cw-inputs { display: flex; gap: 3px; }
        .cw-cell-input { width: 25px; height: 30px; padding: 0; background: #222; border: 1px solid #555; color: white; text-align: center; text-transform: uppercase; }

        .nav-bar { display: none; justify-content: start; gap: 10px; background: #15151a; padding: 10px; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #333; z-index: 1000; overflow-x: auto; white-space: nowrap; }
        .nav-item { color: #666; font-size: 0.65rem; text-align: center; cursor: pointer; min-width: 60px; display: inline-block; }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }
        .nav-icon { display: block; font-size: 1.4rem; }
        
        .feedback { text-align: center; margin-top: 10px; font-weight: bold; padding: 10px; }
        .success-msg { color: var(--success); } .error-msg { color: var(--error); }
    </style>
</head>
<body>

    <audio id="sound-win" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>
    <audio id="sound-lose" src="https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3"></audio>
    <audio id="sound-drum" src="https://www.soundjay.com/percussion/sounds/snare-drum-01.mp3"></audio> 

    <header>
        <div class="header-left">
            <h1 id="app-title">Misi√≥n Hechos</h1>
            <div class="agent-name" id="player-display">Agente: ...</div>
        </div>
        <div class="header-right">
            <div class="timer-box" id="global-timer">00:00</div>
            <div class="score-box" onclick="showStats()">‚≠ê <span id="score-display">0</span></div>
        </div>
    </header>

    <div class="container">
        
        <div id="view-login" class="card active" style="text-align:center;">
            <h2>üïµÔ∏è Archivos de Misi√≥n</h2>
            
            <p style="margin-bottom:5px; color:#aaa;">Selecciona el Cap√≠tulo:</p>
            <select id="chapter-select">
                <option value="17" selected>Cap 17: Heraldos del Evangelio</option>
                <option value="22">Cap 22: Tesal√≥nica</option>
                <option value="16">Cap 16: El Evangelio en Antioqu√≠a</option>
            </select>

            <p style="margin-bottom:5px; color:#aaa; margin-top:20px;">Nombre Agente:</p>
            <input type="text" id="login-name" placeholder="Tu Nombre...">
            
            <button class="btn btn-primary" onclick="handleLogin()">INICIAR MISI√ìN</button>
        </div>

        <div id="view-home" class="card">
            <h2 id="home-title"></h2>
            <div class="img-box">
                <img id="home-img" src="" alt="Imagen Capitulo" onerror="this.src='portada.jpg'">
            </div>
            <p id="home-desc"></p>
            <a id="egw-link" href="#" target="_blank" class="btn btn-primary">üìñ Leer Cap√≠tulo</a>
            <button class="btn" onclick="showStats()" style="border-color:#555; color:#aaa; font-size:0.8rem;">üèÜ Ver Ranking de Agentes</button>
        </div>

        <div id="view-stats" class="card">
            <h2>üèÜ Ranking de Agentes</h2>
            <div style="margin-bottom:20px; padding:10px; background:#222; border-radius:8px;">
                <h3 style="margin:0; font-size:1rem; color:var(--success)">Tu Reporte Actual</h3>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>Puntos: <b id="stat-current" style="color:gold">0</b></span>
                    <span>Tiempo: <b id="stat-time">00:00</b></span>
                </div>
            </div>
            <h3>üèÖ Tabla de Posiciones</h3>
            <table class="stats-table">
                <thead><tr><th>#</th><th>Agente</th><th>Puntos</th></tr></thead>
                <tbody id="ranking-body"></tbody>
            </table>
            <button class="btn btn-primary" onclick="navTo('view-home')">Volver</button>
        </div>

        <div id="view-puzzle" class="card">
            <h2>üß© Puzzle Deslizante</h2>
            <p style="font-size:0.8rem; text-align:center;">Ordena la imagen del cap√≠tulo.</p>
            <div id="puzzle-container"></div>
            <button class="btn" onclick="mixPuzzle()">üîÑ Reiniciar Juego</button>
            <div id="puzzle-feedback" class="feedback"></div>
        </div>

        <div id="view-memory" class="card">
            <h2>üß† Memoria B√≠blica</h2>
            <p style="font-size:0.8rem; text-align:center">Encuentra las parejas.</p>
            <div id="memory-board" class="memory-grid"></div>
            <div id="memory-feedback" class="feedback"></div>
            <button class="btn" onclick="initMemory()" style="margin-top:10px; font-size:0.8rem;">üîÑ Reiniciar</button>
        </div>

        <div id="view-hangman" class="card">
            <h2>üíÄ Ahorcado</h2>
            <p style="text-align:center; color:#ccc;">Pista: <span id="hangman-hint" style="color:var(--accent)"></span></p>
            <div id="hangman-lives" style="text-align:center;"></div>
            <div id="hangman-word"></div>
            <div class="keyboard" id="hangman-keyboard"></div>
            <div id="hangman-feedback" class="feedback"></div>
        </div>

        <div id="view-quiz" class="card">
            <h2>‚ö° Quiz</h2>
            <p style="text-align:right; font-size:0.8rem; color:var(--accent)">Pregunta <span id="quiz-progress">1</span>/3</p>
            <p id="quiz-question" style="font-size:1.1rem; font-weight:bold;"></p>
            <div id="quiz-options"></div>
            <div id="quiz-feedback" class="feedback"></div>
        </div>

        <div id="view-crossword" class="card">
            <h2>üìù Completar</h2>
            <div id="cw-list-container" class="crossword-container"></div>
            <button class="btn" onclick="checkCrossword()">Verificar</button>
            <div id="cw-feedback" class="feedback"></div>
        </div>

        <div id="view-code" class="card">
            <h2>üîì C√≥digo</h2>
            <div style="background:#000; padding:10px; border:1px solid var(--accent); margin-bottom:10px;">
                PISTA: <span id="code-clue" style="color:var(--accent)"></span>
            </div>
            <input type="text" id="code-input" placeholder="Respuesta...">
            <button class="btn" onclick="checkCode()">Desbloquear</button>
            <div id="code-feedback" class="feedback"></div>
        </div>

        <div id="view-words" class="card">
            <h2>üîé Sopa de Letras</h2>
            <div id="word-list" style="color:var(--accent); font-size:0.8rem; margin-bottom:10px;"></div>
            <div id="sopa-game-area">
                <div class="word-grid" id="grid-container"></div>
                <button class="btn btn-primary" onclick="resetSelection()" style="margin-top:10px; font-size:0.8rem;">Borrar Selecci√≥n</button>
            </div>
            <div id="word-success-container" style="display:none; text-align:center; padding:20px; border:2px solid var(--success);">
                <h3 style="color:var(--success)">¬°COMPLETADO!</h3>
            </div>
        </div>

    </div>

    <nav class="nav-bar" id="main-nav">
        <div class="nav-item active" onclick="navTo('view-home')"><span class="nav-icon">üè†</span></div>
        <div class="nav-item" onclick="navTo('view-puzzle')"><span class="nav-icon">üß©</span></div>
        <div class="nav-item" onclick="navTo('view-memory')"><span class="nav-icon">üß†</span></div>
        <div class="nav-item" onclick="navTo('view-hangman')"><span class="nav-icon">üíÄ</span></div>
        <div class="nav-item" onclick="navTo('view-quiz')"><span class="nav-icon">‚ö°</span></div>
        <div class="nav-item" onclick="navTo('view-crossword')"><span class="nav-icon">üìù</span></div>
        <div class="nav-item" onclick="navTo('view-code')"><span class="nav-icon">üîì</span></div>
        <div class="nav-item" onclick="navTo('view-words')"><span class="nav-icon">üîé</span></div>
    </nav>

    <script>
        /* =========================================
           üìö BASE DE DATOS MULTI-CAP√çTULO
           ========================================= */
        const CHAPTERS = {
            "17": {
                title: "Cap 17: Heraldos del Evangelio",
                intro: "Pablo y Bernab√© son apartados por el Esp√≠ritu Santo. Viajan a Chipre y enfrentan al mago Elimas.",
                img: "cap17.jpg", // Aseg√∫rate de tener este archivo
                link: "https://m.egwwritings.org/es/book/198.966",
                memoryPairs: [
                    {a:"Elimas", b:"Mago"}, {a:"Sergio", b:"Proconsul"}, {a:"Chipre", b:"Isla"},
                    {a:"Esp√≠ritu", b:"Santo"}, {a:"Ceguera", b:"Castigo"}, {a:"Juan", b:"Marcos"}
                ],
                hangman: { word: "CEGUERA", hint: "El castigo que recibi√≥ el mago..." },
                quiz: [
                    { q: "¬øQui√©n era Sergio Paulo?", opts: ["Mago","Proc√≥nsul","Sacerdote"], c: 1 },
                    { q: "¬øQui√©n se opuso a Pablo?", opts: ["Elimas","Juan","Bernab√©"], c: 0 },
                    { q: "¬øQu√© ciudad de Chipre visitaron?", opts: ["Pafos","Roma","Atenas"], c: 0 }
                ],
                words: [
                    {p:"Lugar de partida", w:"SELEUCIA"}, 
                    {p:"Primera ciudad en Chipre", w:"SALAMINA"}, 
                    {p:"Donde estaba el proc√≥nsul", w:"PAFOS"}
                ],
                code: { hint: "1-16-1-18-20-1-4-13-5", sol: "APARTADME" }, // Apartadme
                sopa: ["CHIPRE","ELIMAS","SERGIO","PAFOS","PABLO","MAGO"]
            },

            "22": {
                title: "Cap 22: Tesal√≥nica",
                intro: "Pablo y Silas predican en la sinagoga. Muchos creen, pero se desata un alboroto contra Jas√≥n.",
                img: "cap22.jpg", // Busca esta imagen localmente
                link: "https://m.egwwritings.org/es/book/198.684#684",
                memoryPairs: [
                    {a:"Jas√≥n", b:"Hospedador"}, {a:"Tesal√≥nica", b:"Ciudad"}, {a:"C√©sar", b:"Rey"},
                    {a:"Escrituras", b:"Biblia"}, {a:"Pablo", b:"Ap√≥stol"}, {a:"Silas", b:"Compa√±ero"}
                ],
                hangman: { word: "JASON", hint: "Hosped√≥ a Pablo y Silas en su casa..." },
                quiz: [
                    { q: "¬øD√≥nde predic√≥ Pablo por 3 d√≠as?", opts: ["Plaza","Sinagoga","Templo"], c: 1 },
                    { q: "¬øDe qu√© los acusaron?", opts: ["Robar","Trastornar el mundo","Mentir"], c: 1 },
                    { q: "¬øQui√©nes eran los alborotadores?", opts: ["Jud√≠os celosos","Romanos","Griegos"], c: 0 }
                ],
                words: [
                    {p:"Lugar de reuni√≥n jud√≠o", w:"SINAGOGA"}, 
                    {p:"El que los recibi√≥", w:"JASON"}, 
                    {p:"Gobernante mencionado", w:"CESAR"}
                ],
                code: { hint: "21-19-1-20-16-19-14-1-14", sol: "TRASTORNAN" },
                sopa: ["PABLO","SILAS","JASON","GRIEGOS","NOCHE","BEREA"]
            },
            
            "16": {
                title: "Cap 16: El Evangelio en Antioqu√≠a",
                intro: "Los disc√≠pulos llegan a Antioqu√≠a. Bernab√© busca a Pablo y reciben el nombre de Cristianos.",
                img: "portada.jpg",
                link: "https://m.egwwritings.org/es/book/198.920",
                memoryPairs: [
                    {a:"Antioqu√≠a", b:"Capital"}, {a:"Bernab√©", b:"Consolaci√≥n"}, {a:"Pablo", b:"Tarso"},
                    {a:"Cristianos", b:"Nombre"}, {a:"Ayuno", b:"Oraci√≥n"}, {a:"Profetas", b:"Maestros"}
                ],
                hangman: { word: "MISIONEROS", hint: "Fueron enviados a predicar..." },
                quiz: [
                    { q: "¬øQui√©n busc√≥ a Pablo?", opts: ["Pedro","Bernab√©","Juan"], c: 1 },
                    { q: "¬øNuevo nombre recibido?", opts: ["Nazarenos","Cristianos","Santos"], c: 1 },
                    { q: "¬øCapital de Siria?", opts: ["Damasco","Antioqu√≠a","Roma"], c: 1 }
                ],
                words: [{p:"Capital Siria", w:"ANTIOQUIA"}, {p:"Ap√≥stol", w:"PABLO"}, {p:"Nuevo Nombre", w:"CRISTIANOS"}],
                code: { hint: "3-19-9-20-21-9-1-14-16-20", sol: "CRISTIANOS" },
                sopa: ["PABLO","BERNABE","FE","LUZ","AYUNO","TARSO"]
            }
        };

        /* =========================================
           ‚öôÔ∏è SISTEMA
           ========================================= */
        let currentCapID = "17"; 
        let currentData = CHAPTERS["17"]; // Forzar 17
        let currentUser = "";
        let agentData = { totalScore: 0, caps: {} };
        const PTS = 100;
        
        let startTime = 0;
        let timerInterval;
        let isTimerRunning = false;

        let memCards=[], hasFlipped=false, lockBoard=false, firstCard, secondCard;
        let hangmanState={ word:"", guessed:[], lives:6 };
        let quizIdx=0;
        let curWordSel=[], wordsFound=0;
        let pieces = []; let emptySlot = { x: 2, y: 2 };

        function handleLogin() {
            let name = document.getElementById('login-name').value.trim();
            if(!name) return alert("¬°Necesitamos tu nombre, Agente!");
            
            currentUser = name;
            currentCapID = document.getElementById('chapter-select').value;
            currentData = CHAPTERS[currentCapID];

            let saved = localStorage.getItem(`mh_user_${currentUser}`);
            agentData = saved ? JSON.parse(saved) : { totalScore: 0, caps: {} };
            if(!agentData.caps[currentCapID]) agentData.caps[currentCapID] = { score:0, games:[], time: 0 };

            document.getElementById('player-display').innerText = `Agente: ${currentUser}`;
            updateScoreUI();
            
            loadChapterContent();
            
            document.getElementById('main-nav').style.display = 'flex';
            navTo('view-home');
            startTimer(); 
        }

        function loadChapterContent() {
            document.getElementById('home-title').innerText = currentData.title;
            document.getElementById('home-desc').innerText = currentData.intro;
            let imgEl = document.getElementById('home-img');
            
            // Logica de Imagen: Intenta cargar la especifica, sino usa el fallback del HTML
            imgEl.src = currentData.img;
            
            document.getElementById('egw-link').href = currentData.link;
            initMemory();
            initHangman();
            initQuiz();
            initWords(); 
            initCode();
            initSopa();
            initPuzzle();
        }

        function startTimer() {
            if(isTimerRunning) return;
            isTimerRunning = true;
            let savedTime = agentData.caps[currentCapID].time || 0;
            startTime = Date.now() - (savedTime * 1000);

            timerInterval = setInterval(() => {
                let diff = Math.floor((Date.now() - startTime)/1000);
                let m = Math.floor(diff/60).toString().padStart(2,'0');
                let s = (diff%60).toString().padStart(2,'0');
                document.getElementById('global-timer').innerText = m+":"+s;
                
                if(diff % 10 === 0) {
                    agentData.caps[currentCapID].time = diff;
                    localStorage.setItem(`mh_user_${currentUser}`, JSON.stringify(agentData));
                }
            }, 1000);
        }

        function updateScoreUI() {
            let capScore = agentData.caps[currentCapID].score;
            document.getElementById('score-display').innerText = capScore;
        }

        function saveProgress(gameID) {
            let cap = agentData.caps[currentCapID];
            if(!cap.games.includes(gameID)) {
                cap.games.push(gameID);
                cap.score += PTS;
                agentData.totalScore += PTS;
                cap.time = Math.floor((Date.now() - startTime)/1000);
                localStorage.setItem(`mh_user_${currentUser}`, JSON.stringify(agentData));
                updateScoreUI();
                playSound('win');
            }
        }

        function showStats() {
            document.getElementById('stat-name').innerText = currentUser;
            document.getElementById('stat-current').innerText = agentData.caps[currentCapID].score;
            document.getElementById('stat-total').innerText = agentData.totalScore;
            
            let t = agentData.caps[currentCapID].time || 0;
            let m = Math.floor(t/60).toString().padStart(2,'0');
            let s = (t%60).toString().padStart(2,'0');
            document.getElementById('stat-time').innerText = m+":"+s;

            generateRanking();
            navTo('view-stats');
        }

        function generateRanking() {
            let tbody = document.getElementById('ranking-body');
            tbody.innerHTML = "";
            let allUsers = [];
            for (let i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                if(key.startsWith('mh_user_')) {
                    let name = key.replace('mh_user_', '');
                    let data = JSON.parse(localStorage.getItem(key));
                    allUsers.push({ name: name, score: data.totalScore });
                }
            }
            allUsers.sort((a,b) => b.score - a.score);
            allUsers.slice(0, 10).forEach((u, i) => {
                let cl = i===0?'rank-1':(i===1?'rank-2':(i===2?'rank-3':''));
                tbody.innerHTML += `<tr><td class="${cl}">${i+1}</td><td class="${cl}">${u.name}</td><td class="${cl}">${u.score}</td></tr>`;
            });
        }

        function navTo(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        function playSound(t) {
            let id = t==='win'?'sound-win':(t==='drum'?'sound-drum':'sound-lose');
            let a = document.getElementById(id);
            if(a) { a.currentTime=0; a.play().catch(()=>{}); }
        }

        /* --- JUEGOS LOGICA --- */
        
        // PUZZLE
        function initPuzzle() {
            const c = document.getElementById('puzzle-container'); c.innerHTML = ''; pieces = [];
            
            // Si la imagen falla (es un mapa fallback), usamos una imagen generica o color para el puzzle
            let bgImage = currentData.img;
            
            for(let y=0; y<3; y++) {
                for(let x=0; x<3; x++) {
                    if(x===2 && y===2) continue;
                    let p = document.createElement('div'); p.className = 'puzzle-piece';
                    p.style.left = (x*100) + 'px'; p.style.top = (y*100) + 'px';
                    p.style.backgroundImage = `url('${bgImage}'), url('portada.jpg')`; // Fallback en CSS
                    p.style.backgroundPosition = `-${x*100}px -${y*100}px`;
                    p.x = x; p.y = y; p.correctX = x; p.correctY = y;
                    p.onclick = () => movePiece(p);
                    c.appendChild(p); pieces.push(p);
                }
            } emptySlot = { x: 2, y: 2 }; setTimeout(mixPuzzle, 500);
        }
        function movePiece(p) {
            if (Math.abs(p.x - emptySlot.x) + Math.abs(p.y - emptySlot.y) === 1) {
                p.style.left = (emptySlot.x * 100) + 'px'; p.style.top = (emptySlot.y * 100) + 'px';
                let tempX = p.x; let tempY = p.y;
                p.x = emptySlot.x; p.y = emptySlot.y;
                emptySlot.x = tempX; emptySlot.y = tempY;
                checkPuzzleWin();
            }
        }
        function mixPuzzle() {
            for(let i=0; i<150; i++) {
                let neighbors = pieces.filter(p => Math.abs(p.x - emptySlot.x) + Math.abs(p.y - emptySlot.y) === 1);
                if(neighbors.length > 0) {
                    let r = neighbors[Math.floor(Math.random() * neighbors.length)];
                    let tX = r.x; let tY = r.y;
                    r.x = emptySlot.x; r.y = emptySlot.y;
                    r.style.left = (emptySlot.x * 100) + 'px'; r.style.top = (emptySlot.y * 100) + 'px';
                    emptySlot.x = tX; emptySlot.y = tY;
                }
            }
            document.getElementById('puzzle-feedback').innerHTML = "";
        }
        function checkPuzzleWin() {
            if(pieces.every(p => p.x === p.correctX && p.y === p.correctY)) {
                document.getElementById('puzzle-feedback').innerHTML = "<span class='success-msg'>¬°COMPLETADO! (+100)</span>";
                saveProgress('puzzle');
            }
        }

        // MEMORIA
        function initMemory() {
            let b = document.getElementById('memory-board'); b.innerHTML=""; memCards=[];
            currentData.memoryPairs.forEach((p,i) => {
                memCards.push({id:i, t:p.a}); memCards.push({id:i, t:p.b});
            });
            memCards.sort(()=>Math.random()-0.5);
            memCards.forEach(c => {
                let d = document.createElement('div'); d.className='mem-card'; d.innerText="?";
                d.onclick = () => flipCard(d, c);
                b.appendChild(d);
            });
            document.getElementById('memory-feedback').innerHTML="";
        }
        function flipCard(el, card) {
            if(lockBoard || el===firstCard || el.classList.contains('matched')) return;
            el.classList.add('flipped'); el.innerText = card.t;
            if(!hasFlipped) { hasFlipped=true; firstCard={el, card}; return; }
            secondCard={el, card}; lockBoard=true;
            if(firstCard.card.id === secondCard.card.id) {
                firstCard.el.classList.add('matched'); secondCard.el.classList.add('matched');
                resetBoard();
                if(document.querySelectorAll('.mem-card.matched').length === memCards.length) {
                    document.getElementById('memory-feedback').innerHTML="<span class='success-msg'>¬°COMPLETADO! (+100)</span>";
                    saveProgress('memory');
                }
            } else {
                setTimeout(()=>{
                    firstCard.el.classList.remove('flipped'); firstCard.el.innerText="?";
                    secondCard.el.classList.remove('flipped'); secondCard.el.innerText="?";
                    resetBoard();
                }, 1000);
            }
        }
        function resetBoard() { [hasFlipped, lockBoard] = [false, false]; [firstCard, secondCard]=[null,null]; }

        // AHORCADO
        function initHangman() {
            hangmanState = { word: currentData.hangman.word, guessed:[], lives:6 };
            document.getElementById('hangman-hint').innerText = currentData.hangman.hint;
            document.getElementById('hangman-feedback').innerHTML="";
            renderHangman();
        }
        function renderHangman() {
            document.getElementById('hangman-lives').innerText = "‚ù§Ô∏è".repeat(hangmanState.lives);
            let dis = "";
            for(let c of hangmanState.word) dis += hangmanState.guessed.includes(c) ? c+" " : "_ ";
            document.getElementById('hangman-word').innerText = dis;
            
            let kb = document.getElementById('hangman-keyboard'); kb.innerHTML="";
            "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l => {
                let b = document.createElement('div'); b.className='key-btn'; b.innerText=l;
                if(hangmanState.guessed.includes(l)) {
                    b.style.opacity="0.3"; 
                    if(hangmanState.word.includes(l)) b.classList.add('correct'); else b.classList.add('wrong');
                }
                b.onclick = () => guessLetter(l);
                kb.appendChild(b);
            });
        }
        function guessLetter(l) {
            if(hangmanState.lives<=0 || hangmanState.guessed.includes(l)) return;
            hangmanState.guessed.push(l);
            if(!hangmanState.word.includes(l)) { hangmanState.lives--; playSound('lose'); }
            
            let won = hangmanState.word.split('').every(c=>hangmanState.guessed.includes(c));
            if(won) {
                document.getElementById('hangman-feedback').innerHTML="<span class='success-msg'>¬°SALVADO! (+100)</span>";
                saveProgress('hangman');
            } else if(hangmanState.lives<=0) {
                document.getElementById('hangman-feedback').innerHTML="<span class='error-msg'>FIN. Era: "+hangmanState.word+"</span>";
            }
            renderHangman();
        }

        // QUIZ
        function initQuiz() { quizIdx=0; loadQ(); }
        function loadQ() {
            if(quizIdx >= currentData.quiz.length) {
                document.getElementById('quiz-question').innerText="¬°Terminado!";
                document.getElementById('quiz-options').innerHTML="";
                document.getElementById('quiz-feedback').innerHTML="<span class='success-msg'>¬°MUY BIEN! (+100)</span>";
                saveProgress('quiz'); return;
            }
            let q = currentData.quiz[quizIdx];
            document.getElementById('quiz-question').innerText = q.q;
            let opts = document.getElementById('quiz-options'); opts.innerHTML="";
            q.opts.forEach((o,i) => {
                let b = document.createElement('button'); b.className='btn'; b.innerText=o;
                b.onclick = () => {
                    if(i===q.c) {
                        playSound('win'); b.style.background="var(--success)"; b.style.color="black";
                        setTimeout(()=>{ quizIdx++; loadQ(); }, 1000);
                    } else {
                        playSound('lose'); b.style.borderColor="var(--error)";
                    }
                };
                opts.appendChild(b);
            });
        }

        // COMPLETAR
        function initWords() {
            let c = document.getElementById('cw-list-container'); c.innerHTML="";
            currentData.words.forEach((w, i) => {
                let h = `<div class="cw-item"><div class="cw-clue">${i+1}. ${w.p}</div><div class="cw-inputs">`;
                for(let l of w.w) h += `<input type="text" class="cw-cell-input" maxlength="1" data-l="${l}">`;
                h += `</div></div>`;
                c.innerHTML += h;
            });
            setTimeout(()=>{
                document.querySelectorAll('.cw-cell-input').forEach((inp, idx, all) => {
                    inp.oninput = function() { if(this.value && all[idx+1]) all[idx+1].focus(); };
                });
            },500);
        }
        function checkCrossword() {
            let err=0;
            document.querySelectorAll('.cw-cell-input').forEach(i => {
                if(i.value.toUpperCase() === i.dataset.l) { 
                    i.style.backgroundColor="#00ff9d"; i.style.color="black"; i.disabled=true; 
                } else { 
                    i.value = i.dataset.l; i.style.color="orange"; err++; 
                }
            });
            if(err===0) {
                document.getElementById('cw-feedback').innerHTML="<span class='success-msg'>¬°PERFECTO! (+100)</span>";
                saveProgress('words');
            } else document.getElementById('cw-feedback').innerHTML="<span class='error-msg'>Revelado</span>";
        }

        // CODIGO
        function initCode() { document.getElementById('code-clue').innerText = currentData.code.hint; }
        function checkCode() {
            let val = document.getElementById('code-input').value.toUpperCase().trim();
            // Validacion mas flexible
            if(val === currentData.code.sol || val.startsWith(currentData.code.sol.split(' ')[0])) {
                document.getElementById('code-feedback').innerHTML="<span class='success-msg'>CORRECTO (+100)</span>";
                saveProgress('code');
            } else document.getElementById('code-feedback').innerHTML="<span class='error-msg'>ERROR</span>";
        }

        // SOPA
        function initSopa() {
            let l=document.getElementById('word-list'), g=document.getElementById('grid-container');
            l.innerHTML=""; g.innerHTML=""; curWordSel=[]; wordsFound=0;
            let letters = new Array(100).fill(null);
            currentData.sopa.forEach(w => {
                l.innerHTML += `<span id="badge-${w}" style="margin-right:5px">#${w}</span>`;
                let placed=false, tryC=0;
                while(!placed && tryC<100) {
                    let dir=Math.random()>0.5?'H':'V', r=Math.floor(Math.random()*10), c=Math.floor(Math.random()*10);
                    let fits=true;
                    for(let i=0; i<w.length; i++) {
                        let idx = dir==='H' ? r*10+(c+i) : (r+i)*10+c;
                        if(c+i>9 || r+i>9 || (letters[idx] && letters[idx]!==w[i])) fits=false;
                    }
                    if(fits) {
                        for(let i=0; i<w.length; i++) letters[dir==='H'?r*10+(c+i):(r+i)*10+c] = w[i];
                        placed=true;
                    } tryC++;
                }
            });
            let abc="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for(let i=0; i<100; i++) {
                let d=document.createElement('div'); d.className='cell'; 
                d.innerText=letters[i]||abc[Math.floor(Math.random()*abc.length)];
                d.onclick=()=>clickSopa(d); g.appendChild(d);
            }
        }
        function clickSopa(el) {
            if(el.classList.contains('selected')) {
                el.classList.remove('selected'); curWordSel=curWordSel.filter(e=>e!==el);
            } else { el.classList.add('selected'); curWordSel.push(el); }
            
            let s = curWordSel.map(e=>e.innerText).join('');
            if(currentData.sopa.includes(s)) foundSopa(s);
            else if(currentData.sopa.includes(s.split('').reverse().join(''))) foundSopa(s.split('').reverse().join(''));
        }
        function foundSopa(w) {
            playSound('drum');
            curWordSel.forEach(e=>{e.classList.remove('selected'); e.classList.add('found')});
            document.getElementById('badge-'+w).style.opacity="0.3";
            curWordSel=[]; wordsFound++;
            if(wordsFound===currentData.sopa.length) {
                document.getElementById('sopa-game-area').style.display='none';
                document.getElementById('word-success-container').style.display='block';
                playSound('win'); saveProgress('sopa');
            }
        }
        function resetSelection() { curWordSel.forEach(e=>e.classList.remove('selected')); curWordSel=[]; }

    </script>
</body>
</html>
