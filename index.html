<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misi√≥n: HECHOS | Cap 17</title>
    <style>
        :root {
            --bg-color: #0f0f13;
            --card-bg: #1a1a20;
            --accent: #ffae00; 
            --text-main: #ffffff;
            --success: #00ff9d;
            --highlight: #2d4638;
            --font-main: 'Segoe UI', Roboto, sans-serif;
        }

        body { 
            background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-main); 
            margin: 0; padding-bottom: 90px; user-select: none;
            background-image: url('portada.jpg'); background-size: cover; background-attachment: fixed; background-position: center;
        }
        
        header { 
            background: rgba(26, 26, 32, 0.95); padding: 8px 15px; border-bottom: 2px solid var(--accent); 
            position: sticky; top: 0; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left h1 { margin: 0; font-size: 0.9rem; color: var(--accent); text-transform: uppercase; }
        .header-left .agent-name { font-size: 0.7rem; color: var(--success); font-weight: bold; }
        .timer-box { font-family: monospace; font-size: 1.1rem; background: #000; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #fff; }
        .score-box { font-size: 0.9rem; font-weight: bold; color: gold; margin-left: 10px; cursor: pointer; }
        .header-right { display: flex; align-items: center; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; display: none; animation: slideUp 0.4s ease-out; }
        .card.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        h2 { border-left: 4px solid var(--accent); padding-left: 10px; margin-top: 0; font-size: 1.2rem; }
        .img-box { width: 100%; border-radius: 10px; overflow: hidden; margin: 15px 0; border: 1px solid #444; background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center;}
        .img-box img { width: 100%; display: block; object-fit: cover; }

        .btn { background: transparent; border: 2px solid var(--accent); color: var(--accent); padding: 12px; border-radius: 50px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 700; text-transform: uppercase; display: block; text-align: center; text-decoration: none; box-sizing: border-box; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent); color: #000; }

        input { background: #25252e; border: 1px solid #444; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; text-align: center; }
        
        .reader-container { text-align: justify; line-height: 1.6; font-size: 1rem; color: #ddd; }
        .reader-paragraph { padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 3px solid #444; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.02); }
        .reader-paragraph.read { background: var(--highlight); border-left-color: var(--success); color: #fff; }
        
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .stats-table td, .stats-table th { padding: 8px; border-bottom: 1px solid #333; text-align: left; }
        .rank-1 { color: gold; } .rank-2 { color: silver; } .rank-3 { color: #cd7f32; }

        .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mem-card { aspect-ratio: 1; background: #333; border-radius: 8px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.7rem; padding: 5px; cursor: pointer; transform: scale(1); transition: 0.3s; }
        .mem-card.flipped { background: var(--accent); color: black; font-weight: bold; border-color: white; transform: scale(1.05); }
        .mem-card.matched { background: var(--success); color: black; opacity: 0.5; pointer-events: none; }

        #hangman-word { font-family: monospace; font-size: 2rem; letter-spacing: 5px; text-align: center; margin: 20px 0; color: var(--success); word-break: break-all;}
        .keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .key-btn { background: #333; padding: 10px 0; text-align: center; border-radius: 4px; cursor: pointer; font-weight: bold; border: 1px solid #444; }
        .key-btn.correct { background: var(--success); color: black; }
        .key-btn.wrong { background: var(--error); opacity: 0.3; }

        #puzzle-container { position: relative; width: 300px; height: 300px; margin: 0 auto; border: 2px solid var(--accent); background: #000; overflow: hidden; border-radius: 8px; }
        .puzzle-piece { position: absolute; width: 100px; height: 100px; background-size: 300px 300px; border: 1px solid #000; box-sizing: border-box; transition: all 0.2s ease; cursor: pointer; background-color: #333; display: flex; justify-content: center; align-items: center; font-size: 2rem; }

        .word-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin-top: 15px; }
        .cell { aspect-ratio: 1; background: #25252e; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 0.8rem; }
        .cell.selected { background: var(--accent); color: black; }
        .cell.found { background: var(--success); color: black; }

        .crossword-container { margin-bottom: 20px; border: 1px solid #333; padding: 10px; border-radius: 8px; }
        .cw-inputs { display: flex; gap: 3px; margin-top: 5px; }
        .cw-cell-input { width: 25px; height: 30px; padding: 0; background: #222; border: 1px solid #555; color: white; text-align: center; text-transform: uppercase; }

        .nav-bar { display: none; justify-content: start; gap: 10px; background: #15151a; padding: 10px; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #333; z-index: 1000; overflow-x: auto; white-space: nowrap; }
        .nav-item { color: #666; font-size: 0.65rem; text-align: center; cursor: pointer; min-width: 60px; display: inline-block; }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }
        .nav-icon { display: block; font-size: 1.4rem; }
        
        .feedback { text-align: center; margin-top: 10px; font-weight: bold; padding: 10px; }
        .success-msg { color: var(--success); } .error-msg { color: var(--error); }
    </style>
</head>
<body>

    <audio id="sound-win" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>
    <audio id="sound-lose" src="https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3"></audio>
    <audio id="sound-drum" src="https://www.soundjay.com/percussion/sounds/snare-drum-01.mp3"></audio> 

    <header>
        <div class="header-left">
            <h1 id="app-title">Misi√≥n Hechos</h1>
            <div class="agent-name" id="player-display">Agente: ...</div>
        </div>
        <div class="header-right">
            <div class="timer-box" id="global-timer">00:00</div>
            <div class="score-box" onclick="showStats()">‚≠ê <span id="score-display">0</span></div>
        </div>
    </header>

    <div class="container">
        
        <div id="view-login" class="card active" style="text-align:center;">
            <h2>üïµÔ∏è Archivos de Misi√≥n</h2>
            <div style="background:#222; padding:15px; border-radius:10px; margin: 20px 0; border:1px solid #444;">
                <h3 style="color:var(--accent); margin:0;">CAP√çTULO 17</h3>
                <p style="margin:5px 0 0 0; color:#ddd;">Heraldos del Evangelio</p>
            </div>
            <p style="margin-bottom:5px; color:#aaa; margin-top:20px;">Nombre Agente:</p>
            <input type="text" id="login-name" placeholder="Tu Nombre...">
            <button class="btn btn-primary" onclick="handleLogin()">INICIAR MISI√ìN</button>
        </div>

        <div id="view-home" class="card">
            <h2 id="home-title"></h2>
            <div class="img-box"><img id="home-img" src="" alt="Imagen Capitulo" onerror="this.src='portada.jpg'"></div>
            <p id="home-desc"></p>
            <button class="btn btn-primary" onclick="initReader()">üìñ Leer y Resaltar</button>
            <button class="btn" onclick="showStats()" style="border-color:#555; color:#aaa; font-size:0.8rem;">üèÜ Ranking</button>
        </div>

        <div id="view-reader" class="card">
            <h2>üìú Libro: Los Hechos</h2>
            <p style="text-align:center; color:#aaa; font-size:0.8rem;">Toca los p√°rrafos para marcar.</p>
            <div id="reader-content" class="reader-container"></div>
            <button class="btn btn-primary" onclick="navTo('view-home')">Volver</button>
        </div>

        <div id="view-stats" class="card">
            <h2>üèÜ Ranking</h2>
            <p>Puntos: <b id="stat-current" style="color:gold">0</b></p>
            <table class="stats-table">
                <thead><tr><th>#</th><th>Agente</th><th>Puntos</th></tr></thead>
                <tbody id="ranking-body"></tbody>
            </table>
            <button class="btn btn-primary" onclick="navTo('view-home')">Volver</button>
        </div>

        <div id="view-puzzle" class="card">
            <h2>üß© Puzzle</h2>
            <div id="puzzle-container"></div>
            <button class="btn" onclick="mixPuzzle()">üîÑ Reiniciar</button>
            <div id="puzzle-feedback" class="feedback"></div>
        </div>

        <div id="view-memory" class="card">
            <h2>üß† Memoria</h2>
            <div id="memory-board" class="memory-grid"></div>
            <div id="memory-feedback" class="feedback"></div>
            <button class="btn" onclick="initMemory()">üîÑ Reiniciar</button>
        </div>

        <div id="view-hangman" class="card">
            <h2>üíÄ Ahorcado</h2>
            <p style="text-align:center;">Pista: <span id="hangman-hint" style="color:var(--accent)"></span></p>
            <div id="hangman-lives" style="text-align:center;"></div>
            <div id="hangman-word"></div>
            <div class="keyboard" id="hangman-keyboard"></div>
            <div id="hangman-feedback" class="feedback"></div>
        </div>

        <div id="view-quiz" class="card">
            <h2>‚ö° Quiz</h2>
            <p id="quiz-question" style="font-size:1.1rem; font-weight:bold;"></p>
            <div id="quiz-options"></div>
            <div id="quiz-feedback" class="feedback"></div>
        </div>

        <div id="view-crossword" class="card">
            <h2>üìù Completar</h2>
            <div id="cw-list-container" class="crossword-container"></div>
            <button class="btn" onclick="checkCrossword()">Verificar</button>
            <div id="cw-feedback" class="feedback"></div>
        </div>

        <div id="view-code" class="card">
            <h2>üîì C√≥digo</h2>
            <p>Pista: <span id="code-clue" style="color:var(--accent)"></span></p>
            <input type="text" id="code-input" placeholder="Respuesta...">
            <button class="btn" onclick="checkCode()">Desbloquear</button>
            <div id="code-feedback" class="feedback"></div>
        </div>

        <div id="view-words" class="card">
            <h2>üîé Sopa de Letras</h2>
            <div id="word-list" style="color:var(--accent); font-size:0.8rem; margin-bottom:10px;"></div>
            <div id="sopa-game-area">
                <div class="word-grid" id="grid-container"></div>
                <button class="btn btn-primary" onclick="resetSelection()">Borrar</button>
            </div>
            <div id="word-success-container" style="display:none; text-align:center; padding:20px;">
                <h3 style="color:var(--success)">¬°COMPLETADO!</h3>
            </div>
        </div>

    </div>

    <nav class="nav-bar" id="main-nav">
        <div class="nav-item active" onclick="navTo('view-home')"><span class="nav-icon">üè†</span></div>
        <div class="nav-item" onclick="navTo('view-puzzle')"><span class="nav-icon">üß©</span></div>
        <div class="nav-item" onclick="navTo('view-memory')"><span class="nav-icon">üß†</span></div>
        <div class="nav-item" onclick="navTo('view-hangman')"><span class="nav-icon">üíÄ</span></div>
        <div class="nav-item" onclick="navTo('view-quiz')"><span class="nav-icon">‚ö°</span></div>
        <div class="nav-item" onclick="navTo('view-crossword')"><span class="nav-icon">üìù</span></div>
        <div class="nav-item" onclick="navTo('view-code')"><span class="nav-icon">üîì</span></div>
        <div class="nav-item" onclick="navTo('view-words')"><span class="nav-icon">üîé</span></div>
    </nav>

    <script>
        /* =========================================
           DATOS SOLO CAP 17
           ========================================= */
        const DATA = {
            title: "Cap 17: Heraldos del Evangelio",
            intro: "Pablo y Bernab√© son apartados por el Esp√≠ritu Santo. Viajan a Chipre y enfrentan al mago Elimas.",
            img: "cap17.jpg",
            text: [
                "Enviados as√≠ por el Esp√≠ritu Santo, Pablo y Bernab√©, despu√©s de su ordenaci√≥n por los hermanos de Antioqu√≠a, 'descendieron a Seleucia: y de all√≠ navegaron a Cipro [Chipre]'. As√≠ empezaron los ap√≥stoles su primera jira misionera.",
                "Chipre era uno de los lugares a los cuales los creyentes hab√≠an hu√≠do de Jerusal√©n por causa de la persecuci√≥n que sigui√≥ a la muerte de Esteban. Bernab√© mismo era 'natural de Cipro'; y ahora √©l y Pablo, acompa√±ados por Juan Marcos, visitaron ese pa√≠s isle√±o.",
                "La madre de Marcos se hab√≠a convertido a la religi√≥n cristiana, y su casa en Jerusal√©n era un asilo para los disc√≠pulos. All√≠ estaban siempre seguros de ser bienvenidos.",
                "Al llegar a Salamina, los ap√≥stoles 'anunciaban la palabra de Dios en las sinagogas de los Jud√≠os.... Y habiendo atravesado toda la isla hasta Papho, hallaron un hombre mago, falso profeta, Jud√≠o, llamado Barjes√∫s'.",
                "El cual estaba con el proc√≥nsul Sergio Paulo, var√≥n prudente. Este, llamando a Bernab√© y a Saulo, deseaba o√≠r la palabra de Dios. Mas les resist√≠a Elimas el encantador, procurando apartar de la fe al proc√≥nsul.",
                "Satan√°s no permite sin lucha que el reino de Dios se edifique en la tierra. Las huestes del mal est√°n empe√±adas en incesante guerra contra los agentes designados para la predicaci√≥n del Evangelio.",
                "Aunque penosamente acosado por Satan√°s, Pablo tuvo valor para increpar a aquel por quien el enemigo estaba trabajando. 'Lleno del Esp√≠ritu Santo', el ap√≥stol, 'poniendo en √©l los ojos, dijo: Oh, lleno de todo enga√±o y de toda maldad, hijo del diablo... ¬øno cesar√°s de trastornar los caminos rectos del Se√±or?'",
                "Y luego cayeron en √©l obscuridad y tinieblas; y andando alrededor, buscaba qui√©n le condujese por la mano. Entonces el proc√≥nsul, viendo lo que hab√≠a sido hecho, crey√≥, maravillado de la doctrina del Se√±or.",
                "El adivino hab√≠a cerrado los ojos a las evidencias de la verdad evang√©lica; y el Se√±or, con justo enojo, ceg√≥ sus ojos naturales, priv√°ndolo de la luz del d√≠a. La ceguera no fu√© permanente, sino temporal, a fin de que le indujese a arrepentirse.",
                "Pablo y sus compa√±eros continuaron viaje a Perga de Panfilia. Su camino era penoso; afrontaban adversidades y privaciones, y estaban acosados por peligros por doquiera.",
                "All√≠ fu√© donde Marcos, abrumado por el temor y el desaliento, vacil√≥ por un tiempo en su prop√≥sito de entregarse de todo coraz√≥n a la obra del Se√±or. No acostumbrado a las penurias, se desalent√≥ y volvi√≥ a Jerusal√©n."
            ],
            memoryPairs: [ {a:"Elimas", b:"Mago"}, {a:"Sergio", b:"Proconsul"}, {a:"Chipre", b:"Isla"}, {a:"Esp√≠ritu", b:"Santo"}, {a:"Ceguera", b:"Castigo"}, {a:"Juan", b:"Marcos"} ],
            hangman: { word: "CEGUERA", hint: "El castigo que recibi√≥ el mago..." },
            quiz: [ { q: "¬øQui√©n era Sergio Paulo?", opts: ["Mago","Proc√≥nsul","Sacerdote"], c: 1 }, { q: "¬øQui√©n se opuso a Pablo?", opts: ["Elimas","Juan","Bernab√©"], c: 0 }, { q: "¬øQu√© ciudad de Chipre visitaron?", opts: ["Pafos","Roma","Atenas"], c: 0 } ],
            words: [ {p:"Lugar de partida", w:"SELEUCIA"}, {p:"Primera ciudad en Chipre", w:"SALAMINA"}, {p:"Donde estaba el proc√≥nsul", w:"PAFOS"} ],
            code: { hint: "1-16-1-18-20-1-4-13-5", sol: "APARTADME" },
            sopa: ["CHIPRE","ELIMAS","SERGIO","PAFOS","PABLO","MAGO"],
            link: "https://m.egwwritings.org/es/book/198.966"
        };

        /* SISTEMA */
        let currentUser = "";
        let agentData = { totalScore: 0, caps: {} };
        const CAP_ID = "17"; 
        const STORAGE_KEY = "mh_fix_v41_"; // Nueva clave para limpiar errores
        const PTS = 100;
        let startTime=0, timerInterval, isTimerRunning=false;
        let memCards=[], hasFlipped=false, lockBoard=false, firstCard, secondCard;
        let hangmanState={ word:"", guessed:[], lives:6 }, quizIdx=0, curWordSel=[], wordsFound=0, pieces=[], emptySlot={x:2,y:2};

        function handleLogin() {
            let name = document.getElementById('login-name').value.trim();
            if(!name) return alert("¬°Nombre requerido!");
            
            currentUser = name;
            let saved = localStorage.getItem(STORAGE_KEY + currentUser);
            
            if (saved) {
                try {
                    agentData = JSON.parse(saved);
                } catch(e) { agentData = { totalScore: 0, caps: {} }; }
            } else {
                agentData = { totalScore: 0, caps: {} };
            }

            if(!agentData.caps) agentData.caps = {};
            if(!agentData.caps[CAP_ID]) agentData.caps[CAP_ID] = { score:0, games:[], time: 0, read: [] };
            
            document.getElementById('player-display').innerText = "Agente: " + currentUser;
            updateScoreUI(); loadChapterContent();
            
            document.getElementById('view-login').classList.remove('active');
            document.getElementById('view-home').classList.add('active');
            document.getElementById('main-nav').style.display = 'flex';
            startTimer(); 
        }

        function loadChapterContent() {
            document.getElementById('home-title').innerText = DATA.title;
            document.getElementById('home-desc').innerText = DATA.intro;
            let img = document.getElementById('home-img');
            img.src = DATA.img;
            img.onerror = function(){ this.src = 'portada.jpg'; };
            
            initReader(); initMemory(); initHangman(); initQuiz(); initWords(); initCode(); initSopa(); initPuzzle();
        }

        function initReader() {
            const container = document.getElementById('reader-content');
            container.innerHTML = "";
            let readP = agentData.caps[CAP_ID].read || [];
            DATA.text.forEach((txt, i) => {
                let p = document.createElement('div');
                p.className = 'reader-paragraph';
                p.innerText = txt;
                if(readP.includes(i)) p.classList.add('read');
                p.onclick = () => { p.classList.toggle('read'); saveRead(i, p.classList.contains('read')); };
                container.appendChild(p);
            });
        }
        function saveRead(i, isRead) {
            let c = agentData.caps[CAP_ID];
            if(!c.read) c.read = [];
            if(isRead) { if(!c.read.includes(i)) c.read.push(i); } else { c.read = c.read.filter(x => x !== i); }
            localStorage.setItem(STORAGE_KEY + currentUser, JSON.stringify(agentData));
        }

        function startTimer() {
            if(isTimerRunning) return;
            isTimerRunning = true;
            let saved = agentData.caps[CAP_ID].time || 0;
            startTime = Date.now() - (saved * 1000);
            timerInterval = setInterval(() => {
                let diff = Math.floor((Date.now() - startTime)/1000);
                let m = Math.floor(diff/60).toString().padStart(2,'0');
                let s = (diff%60).toString().padStart(2,'0');
                let el = document.getElementById('global-timer');
                if(el) el.innerText = m + ":" + s;
                if(diff % 10 === 0) { 
                    agentData.caps[CAP_ID].time = diff; 
                    localStorage.setItem(STORAGE_KEY + currentUser, JSON.stringify(agentData)); 
                }
            }, 1000);
        }

        function updateScoreUI() { document.getElementById('score-display').innerText = agentData.caps[CAP_ID].score; }
        
        function saveProgress(gid) {
            let c = agentData.caps[CAP_ID];
            if(!c.games.includes(gid)) { 
                c.games.push(gid); 
                c.score += PTS; 
                if(!agentData.totalScore) agentData.totalScore=0; 
                agentData.totalScore += PTS; 
                localStorage.setItem(STORAGE_KEY + currentUser, JSON.stringify(agentData)); 
                updateScoreUI(); 
                playSound('win'); 
            }
        }

        function showStats() {
            document.getElementById('stat-current').innerText = agentData.caps[CAP_ID].score;
            let tbody = document.getElementById('ranking-body'); tbody.innerHTML=""; let us=[];
            for(let i=0; i<localStorage.length; i++) {
                let k=localStorage.key(i); if(k.startsWith(STORAGE_KEY)) { let n=k.replace(STORAGE_KEY,''); let d=JSON.parse(localStorage.getItem(k)); if(d.caps && d.caps[CAP_ID]) us.push({n:n, s:d.caps[CAP_ID].score}); }
            }
            us.sort((a,b)=>b.s-a.s); us.slice(0,10).forEach((u,i)=>{ tbody.innerHTML+=`<tr><td class='rank-${i+1}'>${i+1}</td><td>${u.n}</td><td>${u.s}</td></tr>`; });
            navTo('view-stats');
        }

        function navTo(id) { document.querySelectorAll('.card').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function playSound(t) { let id = t==='win'?'sound-win':(t==='drum'?'sound-drum':'sound-lose'); let a = document.getElementById(id); if(a) { a.currentTime=0; a.play().catch(()=>{}); } }

        /* JUEGOS */
        function initMemory() {
            let b = document.getElementById('memory-board'); b.innerHTML=""; memCards=[];
            DATA.memoryPairs.forEach((p,i) => { memCards.push({id:i, t:p.a}); memCards.push({id:i, t:p.b}); });
            memCards.sort(()=>Math.random()-0.5);
            memCards.forEach(c => {
                let d = document.createElement('div'); d.className='mem-card'; d.innerText="?";
                d.onclick = () => flipCard(d, c);
                b.appendChild(d);
            });
            document.getElementById('memory-feedback').innerHTML="";
        }
        function flipCard(el, c) {
            if(lockBoard || el===firstCard || el.classList.contains('matched')) return;
            el.classList.add('flipped'); el.innerText = c.t;
            if(!hasFlipped) { hasFlipped=true; firstCard={el, c}; return; }
            secondCard={el, c}; lockBoard=true;
            if(firstCard.c.id === secondCard.c.id) {
                firstCard.el.classList.add('matched'); secondCard.el.classList.add('matched'); resetBoard();
                if(document.querySelectorAll('.mem-card.matched').length === memCards.length) { document.getElementById('memory-feedback').innerHTML="<span class='success-msg'>¬°COMPLETADO!</span>"; saveProgress('memory'); }
            } else { setTimeout(()=>{ firstCard.el.classList.remove('flipped'); firstCard.el.innerText="?"; secondCard.el.classList.remove('flipped'); secondCard.el.innerText="?"; resetBoard(); }, 1000); }
        }
        function resetBoard() { hasFlipped=false; lockBoard=false; firstCard=null; secondCard=null; }

        function initHangman() { hangmanState={word:DATA.hangman.word, guessed:[], lives:6}; document.getElementById('hangman-hint').innerText=DATA.hangman.hint; document.getElementById('hangman-feedback').innerHTML=""; renderHangman(); }
        function renderHangman() { 
            document.getElementById('hangman-lives').innerText="‚ù§Ô∏è".repeat(hangmanState.lives); 
            let d=""; for(let c of hangmanState.word) d+=hangmanState.guessed.includes(c)?c+" ":"_ "; document.getElementById('hangman-word').innerText=d; 
            let k=document.getElementById('hangman-keyboard'); k.innerHTML=""; 
            "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l=>{ let b=document.createElement('div'); b.className='key-btn'; b.innerText=l; if(hangmanState.guessed.includes(l)){ b.style.opacity="0.3"; if(hangmanState.word.includes(l)) b.classList.add('correct'); else b.classList.add('wrong'); } b.onclick=()=>guess(l); k.appendChild(b); }); 
        }
        function guess(l) { 
            if(hangmanState.lives<=0 || hangmanState.guessed.includes(l)) return; 
            hangmanState.guessed.push(l); 
            if(!hangmanState.word.includes(l)) { hangmanState.lives--; playSound('lose'); } 
            if(hangmanState.word.split('').every(c=>hangmanState.guessed.includes(c))) { document.getElementById('hangman-feedback').innerHTML="<span class='success-msg'>¬°SALVADO!</span>"; saveProgress('hangman'); } 
            else if(hangmanState.lives<=0) { document.getElementById('hangman-feedback').innerHTML="<span class='error-msg'>Era: "+hangmanState.word+"</span>"; } 
            renderHangman(); 
        }

        function initQuiz() { quizIdx=0; loadQ(); }
        function loadQ() { 
            if(quizIdx>=DATA.quiz.length) { document.getElementById('quiz-question').innerText="¬°Fin!"; document.getElementById('quiz-options').innerHTML=""; document.getElementById('quiz-feedback').innerHTML="<span class='success-msg'>¬°MUY BIEN!</span>"; saveProgress('quiz'); return; } 
            let q=DATA.quiz[quizIdx]; document.getElementById('quiz-question').innerText=q.q; let o=document.getElementById('quiz-options'); o.innerHTML=""; 
            q.opts.forEach((op,i)=>{ let b=document.createElement('button'); b.className='btn'; b.innerText=op; b.onclick=()=>{ if(i===q.c){ playSound('win'); b.style.background="var(--success)"; b.style.color="black"; setTimeout(()=>{quizIdx++; loadQ();},1000); } else { playSound('lose'); b.style.borderColor="var(--error)"; } }; o.appendChild(b); }); 
        }

        function initWords() { let c=document.getElementById('cw-list-container'); c.innerHTML=""; DATA.words.forEach((w,i)=>{ let h=`<div style='margin-bottom:10px'><div style='color:#ccc; font-size:0.8rem;'>${i+1}. ${w.p}</div><div class="cw-inputs">`; for(let l of w.w) h+=`<input type="text" class="cw-cell-input" maxlength="1" data-l="${l}">`; h+=`</div></div>`; c.innerHTML+=h; }); setTimeout(()=>{ document.querySelectorAll('.cw-cell-input').forEach((inp,i,a)=>{ inp.oninput=function(){if(this.value && a[i+1]) a[i+1].focus();} }); },500); }
        function checkCrossword() { let err=0; document.querySelectorAll('.cw-cell-input').forEach(i=>{ if(i.value.toUpperCase()===i.dataset.l){ i.style.backgroundColor="#00ff9d"; i.style.color="black"; i.disabled=true; } else { i.value=i.dataset.l; i.style.color="orange"; err++; } }); if(err===0){ document.getElementById('cw-feedback').innerHTML="<span class='success-msg'>¬°PERFECTO!</span>"; saveProgress('words'); } else document.getElementById('cw-feedback').innerHTML="<span class='error-msg'>Revelado</span>"; }

        function checkCode() { let val = document.getElementById('code-input').value.toUpperCase().trim(); if(val === DATA.code.sol || val.startsWith("APARTADME")) { document.getElementById('code-feedback').innerHTML="<span class='success-msg'>CORRECTO</span>"; saveProgress('code'); } else document.getElementById('code-feedback').innerHTML="<span class='error-msg'>ERROR</span>"; document.getElementById('code-clue').innerText = DATA.code.hint; }

        function initSopa() { let l=document.getElementById('word-list'), g=document.getElementById('grid-container'); l.innerHTML=""; g.innerHTML=""; curWordSel=[]; wordsFound=0; let letters=new Array(100).fill(null); DATA.sopa.forEach(w=>{ l.innerHTML+=`<span id="badge-${w}" style="margin-right:5px">#${w}</span>`; let placed=false, tryC=0; while(!placed && tryC<50){ let d=Math.random()>.5?'H':'V', r=Math.floor(Math.random()*10), c=Math.floor(Math.random()*10), fits=true; for(let i=0;i<w.length;i++){ let idx=d==='H'?r*10+(c+i):(r+i)*10+c; if(c+i>9||r+i>9||(letters[idx]&&letters[idx]!==w[i])) fits=false; } if(fits){ for(let i=0;i<w.length;i++) letters[d==='H'?r*10+(c+i):(r+i)*10+c]=w[i]; placed=true; } tryC++; } }); let abc="ABCDEFGHIJKLMNOPQRSTUVWXYZ"; for(let i=0;i<100;i++){ let d=document.createElement('div'); d.className='cell'; d.innerText=letters[i]||abc[Math.floor(Math.random()*abc.length)]; d.onclick=()=>clickSopa(d); g.appendChild(d); } }
        function clickSopa(el) { if(el.classList.contains('selected')) { el.classList.remove('selected'); curWordSel=curWordSel.filter(e=>e!==el); } else { el.classList.add('selected'); curWordSel.push(el); } let s=curWordSel.map(e=>e.innerText).join(''); if(DATA.sopa.includes(s)) foundSopa(s); else if(DATA.sopa.includes(s.split('').reverse().join(''))) foundSopa(s.split('').reverse().join('')); }
        function foundSopa(w) { playSound('drum'); curWordSel.forEach(e=>{e.classList.remove('selected'); e.classList.add('found')}); document.getElementById('badge-'+w).style.opacity="0.3"; curWordSel=[]; wordsFound++; if(wordsFound===DATA.sopa.length) { document.getElementById('sopa-game-area').style.display='none'; document.getElementById('word-success-container').style.display='block'; playSound('win'); saveProgress('sopa'); } }
        function resetSelection() { curWordSel.forEach(e=>e.classList.remove('selected')); curWordSel=[]; }

        function initPuzzle() { const c=document.getElementById('puzzle-container'); c.innerHTML=''; pieces=[]; let bg=DATA.img; for(let y=0;y<3;y++) { for(let x=0;x<3;x++) { if(x===2&&y===2) continue; let p=document.createElement('div'); p.className='puzzle-piece'; p.style.left=(x*100)+'px'; p.style.top=(y*100)+'px'; p.style.backgroundImage=`url('${bg}'), url('portada.jpg')`; p.style.backgroundPosition=`-${x*100}px -${y*100}px`; p.x=x; p.y=y; p.cx=x; p.cy=y; p.onclick=()=>movePiece(p); c.appendChild(p); pieces.push(p); } } emptySlot={x:2,y:2}; setTimeout(mixPuzzle,500); }
        function movePiece(p) { if(Math.abs(p.x-emptySlot.x)+Math.abs(p.y-emptySlot.y)===1) { p.style.left=(emptySlot.x*100)+'px'; p.style.top=(emptySlot.y*100)+'px'; let tx=p.x, ty=p.y; p.x=emptySlot.x; p.y=emptySlot.y; emptySlot.x=tx; emptySlot.y=ty; checkPuzzle(); } }
        function mixPuzzle() { for(let i=0;i<150;i++) { let n=pieces.filter(p=>Math.abs(p.x-emptySlot.x)+Math.abs(p.y-emptySlot.y)===1); if(n.length){ let r=n[Math.floor(Math.random()*n.length)]; let tx=r.x, ty=r.y; r.x=emptySlot.x; r.y=emptySlot.y; r.style.left=(emptySlot.x*100)+'px'; r.style.top=(emptySlot.y*100)+'px'; emptySlot.x=tx; emptySlot.y=ty; } } document.getElementById('puzzle-feedback').innerHTML=""; }
        function checkPuzzle() { if(pieces.every(p=>p.x===p.cx && p.y===p.cy)) { document.getElementById('puzzle-feedback').innerHTML="<span class='success-msg'>¬°COMPLETADO!</span>"; saveProgress('puzzle'); } }
    </script>
</body>
</html>
